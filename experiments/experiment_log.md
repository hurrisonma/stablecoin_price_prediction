# 实验日志

## 实验索引

| 实验ID | 日期 | 特征 | Macro F1 | 状态 |
|--------|------|------|----------|------|
| #001 | 12-07 | 57个完整 | 0.3332 | ❌ 标签问题 |
| #002 | 12-07 | 57个完整 | 0.4614 | ✅ 基准线 |
| #003 | 12-07 | 21个精简 | 0.4757 | ✅ |
| #004 | 12-07 | 21个+大模型 | 0.4341 | ❌ 过拟合 |
| #005 | 12-07 | 1个(net_accel) | 0.4047 | 单特征 |
| **#006** | 12-07 | **速度+比例+加速度(6)** | **0.4950** | 🏆 三分类最佳 |
| #007c | 12-07 | 深度+比例(4) | 0.4734 | 消融测试 |
| #007d | 12-07 | 速度+比例(4) | 0.4254 | 消融测试 |
| #016 | 12-07 | 二分类4特征(5min) | - | 样本级评估 |
| **#017** | 12-07 | **二分类4特征(10min)** | **-** | 🏆 **事件级评估** |

---

## 🆕 新模式：二分类下跌检测 + 事件级别评估

**目标重定义**：
- 只预测"下跌" vs "不下跌"
- **不容忍**：预测下跌但实际上涨（方向错误）
- **可容忍**：预测下跌但实际不变（假阳性）

**评估方式**：事件级别去重（连续相同标签合并为一个事件）

---

### #017 - 二分类下跌检测 🏆 最终模型

**目标**：0错误 + 最高捕获率

**最佳配置**：
- 特征(4个)：`bid1_qty`, `bid1_velocity`, `bid_ratio_12`, `imbalance_1`
- 预测周期：10分钟
- 回看窗口：40分钟
- 隐藏层：96
- **种子：10**
- **阈值：0.85**

**最终结果**：
- **方向错误：0** ✅
- **捕获率：54%（27/50事件）**

**训练脚本**：`train_down_detector.py`

---

### 📋 优化实验汇总

| # | 方向 | 状态 | 结果 |
|---|------|------|------|
| A | 隐藏层调参 | ✅ | hidden=96最佳 |
| E | 阈值优化 | ✅ | seed=10+阈值0.85=0错误 |
| B | 特征变体 | ✅ | 原始组合最佳 |
| C | 多次运行 | ✅ | 验证随机性影响大 |
| D | 集成学习 | ✅ | 可实现0错误 |
| F | 买二特征 | ✅ | 无明显提升 |

## 🔑 关键发现：特征消融实验

| 特征组合 | Macro F1 | 结论 |
|----------|----------|------|
| 速度+比例+**加速度** | **0.4950** | 三分类最佳 |
| 深度+比例 (无加速度) | 0.4734 | 次优 |
| 速度+比例 (无加速度) | 0.4254 | 差 |

**核心结论**：
1. 三分类问题中加速度很重要
2. 二分类下跌检测中，去掉加速度反而更好



---

## 实验 #001 - 标签问题导致失败

**日期**: 2025-12-07

**问题**: 标签生成存在三个bug (mid-price精度、浮点比较、往返抵消)

**结论**: 实验无效，已修复

---

## 实验 #002 - 基准实验 (57特征)

**日期**: 2025-12-07

### 配置
```yaml
模型: SimpleLSTM (1层, hidden=64)
特征: 57个 (完整特征集)
损失函数: Focal Loss
类别权重: [15, 1, 15]
```

### 结果
| 指标 | 值 |
|------|-----|
| Accuracy | 88.10% |
| **Macro F1** | **0.4614** |
| 模型参数 | 31,683 |

### 各类别
| 类别 | Precision | Recall | F1 |
|------|-----------|--------|-----|
| 下降 | 22.54% | 22.22% | 0.2238 |
| 不变 | 98.04% | 89.49% | 0.9357 |
| 上涨 | 13.19% | 76.35% | 0.2249 |

---

## 实验 #003 - 精简特征集 (21特征) ⭐ 当前最佳

**日期**: 2025-12-07

### 配置
```yaml
模型: SimpleLSTM (1层, hidden=64)
特征: 21个 (精简特征集)
损失函数: Focal Loss
类别权重: [15, 1, 15]
训练轮数: 14 (早停)
```

### 精简特征列表
```
一档加速度: bid1_accel, ask1_accel, net_accel_1
一档速度: bid1_velocity, ask1_velocity, net_velocity_1
不平衡: imbalance_1, imbalance_1_velocity, imbalance_1_accel
聪明钱指标: bid_ratio_12_velocity, ask_ratio_12_velocity, ratio_diff_velocity
累计加速度: net_accel_1_sum/mean_5/15/30, accel_std_5/15/30
```

### 结果
| 指标 | 值 | vs #002 |
|------|-----|---------|
| Accuracy | 89.91% | ✅ +1.8% |
| **Macro F1** | **0.4757** | ✅ +0.014 |
| 模型参数 | 22,467 | ↓ -29% |

### 各类别
| 类别 | Precision | Recall | F1 | vs #002 |
|------|-----------|--------|-----|---------|
| 下降 | 14.29% | 31.25% | 0.1961 | Recall ✅+9% |
| 不变 | 98.05% | 91.41% | 0.9462 | ✅+1% |
| 上涨 | 18.25% | 64.86% | 0.2849 | Recall ↓-11% |

### 混淆矩阵
```
预测      下降    不变    上升
实际
下降       45      99       0
不变      266    7408     430
上升        4      48      96
```

### 分析
- 精简特征反而略好，说明去掉的特征是噪声
- 模型更小更快，参数减少29%
- 下降识别有提升，上涨有所下降

---

## 实验对比总结

| 对比项 | #002 (57特征) | #003 (21特征) |
|--------|---------------|---------------|
| Macro F1 | 0.4614 | **0.4757** |
| 下降 Recall | 22% | **31%** |
| 上涨 Recall | **76%** | 65% |
| 参数量 | 31,683 | **22,467** |

---

## 下一步计划

- [ ] 实验 #004: 增加模型容量 (hidden=128, layers=2)
- [ ] 实验 #005: 使用 LSTM + Attention
- [ ] 实验 #006: 调整类别权重 (增大少数类权重)
- [ ] 实验 #007: 尝试 Transformer

---
